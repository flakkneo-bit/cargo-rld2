<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Dashboard - Cargo RLD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#2c5364,#203a43,#0f2027);color:#fff;transition:margin-left 0.3s;}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(0,0,0,0.2);}
.menu{font-size:26px;cursor:pointer;}
.profile{width:40px;height:40px;background:#ccc;border-radius:50%;cursor:pointer;}
.box{background:#fff;color:#333;padding:25px;border-radius:12px;max-width:450px;margin:20px auto;box-shadow:0 10px 30px rgba(0,0,0,0.35);text-align:center;}
h2{color:#2c5364;}
button{width:100%;padding:14px;margin-top:12px;font-size:16px;border:none;border-radius:8px;cursor:pointer;}
.primary{background:#2980b9;color:white;}
.secondary{background:#27ae60;color:white;}
.drivers-section,.chat-section{display:none;text-align:left;margin-top:20px;}
.driver{background:#ecf0f1;color:#333;padding:10px;margin-bottom:10px;border-radius:8px;}
.send-btn{width:100%;padding:10px;margin-top:5px;background:#f39c12;color:white;border:none;border-radius:6px;cursor:pointer;}
.request-list{margin-top:20px;}
.request-item{border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:10px;background:#ecf0f1;color:#333;}
.message{max-width:70%;margin:5px 0;padding:10px;border-radius:10px;clear:both;word-wrap:break-word;}
.customer-msg{background:#2980b9;color:white;float:left;}
.driver-msg{background:#fff;color:#333;float:right;}
.chat-input{width:100%;padding:10px;margin-top:5px;border-radius:8px;border:none;font-size:14px;}
.send-btn-chat{padding:10px;margin-top:5px;width:100%;border:none;border-radius:6px;background:#f39c12;color:white;cursor:pointer;}

/* Sidebar */
.sidebar{height:100%;width:0;position:fixed;z-index:10;top:0;left:0;background:#1a1a1a;overflow-x:hidden;transition:0.3s;padding-top:60px;}
.sidebar .closebtn{position:absolute;top:15px;right:25px;font-size:30px;cursor:pointer;}
.sidebar img{width:80px;height:80px;border-radius:50%;display:block;margin:0 auto 10px;}
.sidebar h3,p{text-align:center;margin:5px 0;color:white;}
.sidebar a{padding:10px 15px;text-decoration:none;font-size:18px;color:#ccc;display:flex;align-items:center;border-bottom:1px solid #333;position:relative;}
.sidebar a:hover{background:#2980b9;color:white;}
.sidebar i{margin-right:12px;}
.notification-badge{display:inline-block;background:red;color:white;font-size:12px;width:18px;height:18px;border-radius:50%;text-align:center;line-height:18px;margin-left:5px;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBdnINehUrDecKFqux3h9PAQJ03Du96Nj8",
  authDomain: "cargo-rld2.firebaseapp.com",
  projectId: "cargo-rld2",
  storageBucket: "cargo-rld2.firebasestorage.app",
  messagingSenderId: "15997765872",
  appId: "1:15997765872:web:b5bef9659a5f300e545a35"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>
</head>

<body>
<div class="topbar">
  <div class="menu" onclick="openSidebar()">â˜°</div>
  <div class="profile" onclick="goProfile()"></div>
</div>

<div class="box">
  <h2>Welcome to Cargo RLD</h2>
  <p>Manage your deliveries and find drivers easily</p>

  <button class="primary" onclick="toggleDrivers()">ðŸšš View Available Drivers</button>
  <button class="primary" onclick="toggleRequests()">ðŸ“‹ My Requests</button>
  <button class="secondary" onclick="toggleChat()">ðŸ’¬ Chat</button>

  <div class="drivers-section" id="driversSection"></div>
  <div class="request-list" id="requestList"></div>
  <div class="chat-section" id="chatSection">
    <div id="chatMessages" style="max-height:300px;overflow-y:auto;"></div>
    <input type="text" id="chatInput" class="chat-input" placeholder="Type a message...">
    <button class="send-btn-chat" onclick="sendChat()">Send</button>
  </div>
</div>

<div id="mySidebar" class="sidebar">
  <span class="closebtn" onclick="closeSidebar()">Ã—</span>
  <img src="profile.png" alt="Profile">
  <h3 id="sidebarName">Demo Customer</h3>
  <p id="sidebarRole">Customer</p>

  <a href="requests.html" id="requestLink"><i class="fa fa-clipboard-list"></i> Requests<span class="notification-badge" id="requestNotif" style="display:none">0</span></a>
  <a href="chat.html" onclick="localStorage.setItem('chatRole','customer')"><i class="fa fa-comment"></i> Chat<span class="notification-badge" id="chatNotif" style="display:none">0</span></a>
  <a href="payment.html"><i class="fa fa-credit-card"></i> Payment</a>
  <a href="subscription.html"><i class="fa fa-dollar-sign"></i> Subscription</a>
  <a href="tracking.html"><i class="fa fa-location-dot"></i> Tracking</a>
  <a href="points.html"><i class="fa fa-coins"></i> Points</a>
  <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
</div>

<script>
function openSidebar(){document.getElementById("mySidebar").style.width="250px";}
function closeSidebar(){document.getElementById("mySidebar").style.width="0";}
function goProfile(){window.location.href="profile.html";}

/* Toggle sections */
function toggleDrivers(){
  const s=document.getElementById("driversSection");
  s.style.display=s.style.display==="block"?"none":"block";
  loadDrivers();
}
function toggleRequests(){
  const s=document.getElementById("requestList");
  s.style.display=s.style.display==="block"?"none":"block";
  loadCustomerRequests();
}
function toggleChat(){
  const s=document.getElementById("chatSection");
  s.style.display=s.style.display==="block"?"none":"block";
  loadChat();
}

/* Load drivers from Firestore */
function loadDrivers(){
  const section=document.getElementById("driversSection");
  section.innerHTML='';
  db.collection("users").where("role","==","driver").get()
    .then(snapshot=>{
      snapshot.forEach(doc=>{
        const data = doc.data();
        const div=document.createElement('div');
        div.className='driver';
        div.innerHTML=`
          <p><b>Name:</b> ${data.name}</p>
          <p><b>Email:</b> ${data.email}</p>
          <button class="send-btn" onclick="sendRequest('${doc.id}','${data.name}')">Send Request</button>
        `;
        section.appendChild(div);
      });
    });
}

/* Send request to driver */
function sendRequest(driverId, driverName){
  const user = auth.currentUser;
  if(!user){alert("Please login first"); return;}
  db.collection("requests").add({
    customerId: user.uid,
    driverId: driverId,
    status: "Pending",
    created: Date.now()
  }).then(()=>{
    alert("ðŸ“£ Request sent to "+driverName);
    updateRequestNotification();
  });
}

/* Load customer requests */
function loadCustomerRequests(){
  const section=document.getElementById("requestList");
  section.innerHTML='';
  const user = auth.currentUser;
  if(!user){alert("Please login first"); return;}
  db.collection("requests").where("customerId","==",user.uid).get()
    .then(snapshot=>{
      snapshot.forEach(doc=>{
        const r = doc.data();
        const div=document.createElement('div');
        div.className='request-item';
        div.innerHTML=`
          <p><b>Status:</b> ${r.status}</p>
          <p><b>Driver:</b> ${r.driverId||'Not assigned yet'}</p>
          <p><b>Created:</b> ${new Date(r.created).toLocaleString()}</p>
        `;
        section.appendChild(div);
      });
    });
}

/* Chat */
function loadChat(){
  const chatContainer=document.getElementById("chatMessages");
  chatContainer.innerHTML='';
  const user = auth.currentUser;
  if(!user) return;
  db.collection("chats")
    .where("customerId","==",user.uid)
    .orderBy("created")
    .get()
    .then(snapshot=>{
      snapshot.forEach(doc=>{
        const c=doc.data();
        const div=document.createElement('div');
        div.className='message '+(c.from==="customer"?"customer-msg":"driver-msg");
        div.innerText=c.message;
        chatContainer.appendChild(div);
      });
      chatContainer.scrollTop=chatContainer.scrollHeight;
    });
}

function sendChat(){
  const input=document.getElementById("chatInput");
  const msg=input.value.trim();
  if(msg==='') return;
  const user = auth.currentUser;
  if(!user) return;

  db.collection("chats").add({
    customerId:user.uid,
    from:"customer",
    message:msg,
    created:Date.now()
  }).then(()=>{
    input.value='';
    loadChat();
    updateChatNotification();
  });
}

/* Notifications */
function updateRequestNotification(){
  const user = auth.currentUser;
  if(!user) return;
  db.collection("requests").where("customerId","==",user.uid).where("status","==","Pending").get()
    .then(snap=>{
      const badge=document.getElementById("requestNotif");
      badge.innerText=snap.size;
      badge.style.display = snap.size>0?"inline-block":"none";
    });
}

function updateChatNotification(){
  const user = auth.currentUser;
  if(!user) return;
  db.collection("chats").where("customerId","==",user.uid).where("read","==",false).get()
    .then(snap=>{
      const badge=document.getElementById("chatNotif");
      badge.innerText=snap.size;
      badge.style.display = snap.size>0?"inline-block":"none";
    });
}

/* Check login */
auth.onAuthStateChanged(user=>{
  if(user){
    db.collection("users").doc(user.uid).get().then(doc=>{
      if(doc.exists){
        document.getElementById("sidebarName").innerText = doc.data().name;
      }
    });
    updateRequestNotification();
    updateChatNotification();
  } else {
    window.location.href="login.html";
  }
});
</script>

</body>
</html>
