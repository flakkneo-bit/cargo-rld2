<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Dashboard - Cargo RLD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#2c5364,#203a43,#0f2027);
  color:#fff;
}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px;
  background:rgba(0,0,0,0.3);
}
.menu{font-size:26px;cursor:pointer;}
.box{
  background:#fff;
  color:#333;
  padding:25px;
  border-radius:12px;
  max-width:500px;
  margin:20px auto;
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:#2980b9;color:#fff;}
.secondary{background:#27ae60;color:#fff;}
.section{display:none;margin-top:15px;}
.item{
  background:#ecf0f1;
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
}
input{
  width:100%;
  padding:10px;
  margin-top:8px;
}
.chat-box{
  max-height:250px;
  overflow-y:auto;
  background:#f2f2f2;
  padding:10px;
  border-radius:8px;
}
.msg{
  margin:5px 0;
  padding:8px;
  border-radius:6px;
  max-width:70%;
}
.customer{background:#2980b9;color:#fff;}
.driver{background:#ddd;color:#333;margin-left:auto;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBdnINehUrDecKFqux3h9PAQJ03Du96Nj8",
  authDomain: "cargo-rld2.firebaseapp.com",
  projectId: "cargo-rld2"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;

auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="index.html";
  }else{
    currentUser=user;
    loadRequests();
    loadChat();
  }
});

function toggle(id){
  const el=document.getElementById(id);
  el.style.display=el.style.display==="block"?"none":"block";
}

/* REQUESTS */
function createRequest(){
  db.collection("requests").add({
    customerId:currentUser.uid,
    status:"Pending",
    created:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    alert("Request created");
  });
}

function loadRequests(){
  db.collection("requests")
  .where("customerId","==",currentUser.uid)
  .orderBy("created","desc")
  .onSnapshot(snap=>{
    const list=document.getElementById("requests");
    list.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <b>Status:</b> ${d.status}<br>
        <small>ID: ${doc.id}</small>
      `;
      list.appendChild(div);
    });
  });
}

/* CHAT */
function sendMessage(){
  const msg=document.getElementById("chatInput").value.trim();
  if(msg==="") return;

  db.collection("chats").add({
    from:"customer",
    customerId:currentUser.uid,
    message:msg,
    created:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("chatInput").value="";
}

function loadChat(){
  db.collection("chats")
  .where("customerId","==",currentUser.uid)
  .orderBy("created")
  .onSnapshot(snap=>{
    const box=document.getElementById("chatBox");
    box.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      const div=document.createElement("div");
      div.className="msg "+(d.from==="customer"?"customer":"driver");
      div.innerText=d.message;
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  });
}

function logout(){
  auth.signOut().then(()=>window.location.href="index.html");
}
</script>
</head>

<body>

<div class="topbar">
  <div class="menu">â˜° Customer Dashboard</div>
  <button onclick="logout()">Logout</button>
</div>

<div class="box">
  <button class="primary" onclick="toggle('requestSection')">ðŸ“¦ Create Request</button>
  <button class="primary" onclick="toggle('myRequests')">ðŸ“‹ My Requests</button>
  <button class="secondary" onclick="toggle('chatSection')">ðŸ’¬ Chat</button>

  <div id="requestSection" class="section">
    <button onclick="createRequest()">Create New Request</button>
  </div>

  <div id="myRequests" class="section">
    <div id="requests"></div>
  </div>

  <div id="chatSection" class="section">
    <div id="chatBox" class="chat-box"></div>
    <input id="chatInput" placeholder="Type message...">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

</body>
</html>
